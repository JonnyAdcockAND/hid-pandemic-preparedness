---
import { getCollection } from "astro:content";
import _ from "lodash";
import sanitizeHtml from "sanitize-html";
import util from "util";

import BaseLayout from "@layouts/BaseLayout.astro";

// Interfaces
import type { FilterMenuProps as FilterableQuestionsProps } from "@components/QuestionBank/FilterMenu/FilterMenu.interface";
import type { QuestionBlockProps } from "@components/QuestionBank/QuestionBlock/QuestionBlock.interface";

// Components
import { Header } from "@components/Core/Header/Header";
import { FilterMenu as FilterableQuestions } from "@components/QuestionBank/FilterMenu/FilterMenu";
import { References } from "@components/References/References";

// Helpers
import { parseMarkdown } from "@helpers/parseMarkdown";

// Content
import headerData from "@content/tools/question-bank/header.json";
import questionBlocksData from "@content/tools/question-bank/questionBlocks.json";
import referencesData from "@content/Home/references.json";

const currentRoute: string = Astro.url.pathname;

// Trim leading slash from current route so we can use to filter returned collections
const filterUrl: string = currentRoute.replace(/^\//, "");

// Get explainer markdown
const explainerData = await getCollection("toolsExplainer", ({ id }) => {
  return id === `${filterUrl}explainer`;
});

// Get content markdown
const contentData = await getCollection("toolsContent", ({ id }) => {
  return id === `${filterUrl}content`;
});

console.log(
  util.inspect(contentData, {
    showHidden: false,
    depth: null,
    colors: true,
  }),
);

console.log(
  util.inspect(questionBlocksData, {
    showHidden: false,
    depth: null,
    colors: true,
  }),
);

// Get the unique tags from the question block data to build filter
const uniqueTags = _.uniqBy(
  questionBlocksData.flatMap((item) => item.tags),
  "id",
);

const filterMenuData = {
  title: "Theme",
  checkItems: uniqueTags.map((tag) => ({ label: tag.title, id: tag.id })),
  inverse: false,
};

console.log(filterMenuData);

const filterableQuestionsData: FilterableQuestionsProps = {
  explainer: {
    htmlContent: explainerData[0].rendered?.html ?? "",
  },
  filterMenu: filterMenuData,
  questionBlocks: questionBlocksData as QuestionBlockProps[],
};

//   explainer: ExplainerProps;
//   filterMenu: ListGroupChecksProps;
//   questionBlocks: QuestionBlockProps[];
---

<BaseLayout title={headerData.title}>
  <main>
    <Header {...headerData} />
    <FilterableQuestions {...filterableQuestionsData} client:visible />
    <References {...referencesData} client:visible />
  </main>
</BaseLayout>
